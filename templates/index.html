<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prédicteur de Type de Cancer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .gene-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .result-card {
            transition: all 0.3s ease;
            transform: scale(0.95);
        }
        .result-card.active {
            transform: scale(1);
            box-shadow: 0 0 15px rgba(0,123,255,0.5);
        }
        #loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Prédicteur de Type de Cancer basé sur l'Expression Génique</h1>
        
        {% if not ml_ready %}
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">Modèle non disponible!</h4>
            <p>Le modèle d'apprentissage automatique n'a pas été trouvé. Veuillez d'abord exécuter le script d'entraînement pour générer les fichiers nécessaires:</p>
            <ol>
                <li>Exécutez <code>python train_model.py</code> pour entraîner et sauvegarder le modèle</li>
                <li>Assurez-vous que les fichiers <code>cancer_classifier_model.h5</code> et <code>scaler.pkl</code> sont présents dans le répertoire du projet</li>
                <li>Redémarrez l'application Flask</li>
            </ol>
        </div>
        {% endif %}
        
        <div class="card mb-4 {% if not ml_ready %}opacity-50{% endif %}">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Entrez les valeurs d'expression génique</h3>
            </div>
            <div class="card-body">
                <form id="gene-form">
                    <div class="mb-3">
                        <button type="button" id="loadSample" class="btn btn-secondary mb-3" {% if not ml_ready %}disabled{% endif %}>Charger un exemple</button>
                        <button type="button" id="clearForm" class="btn btn-outline-danger mb-3 ms-2" {% if not ml_ready %}disabled{% endif %}>Effacer</button>
                    </div>
                    
                    <div class="gene-grid">
                        {% for gene in genes %}
                        <div class="mb-2">
                            <label for="{{ gene }}" class="form-label small">{{ gene }}</label>
                            <input type="number" step="any" class="form-control form-control-sm" id="{{ gene }}" name="{{ gene }}" placeholder="0" {% if not ml_ready %}disabled{% endif %}>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary" {% if not ml_ready %}disabled{% endif %}>Prédire le type de cancer</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="results" class="row" style="display: none;">
            <div class="col-md-6">
                <div class="card result-card active">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">Résultat de la prédiction</h3>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h4>Type de cancer prédit:</h4>
                            <h2 id="predicted-type" class="text-primary"></h2>
                            <div class="progress mt-2">
                                <div id="confidence-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <p class="mt-2">Confiance: <span id="confidence-value">0</span>%</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card result-card">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0">Distribution des probabilités</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="probability-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    </div>
    
    <script>
        let chart = null;
        const mlReady = {{ 'true' if ml_ready else 'false' }};
        
        // Désactiver le formulaire si le modèle n'est pas prêt
        if (!mlReady) {
            const inputs = document.querySelectorAll('#gene-form input');
            inputs.forEach(input => input.disabled = true);
        }
        
        document.getElementById('gene-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!mlReady) {
                alert("Le modèle n'est pas disponible. Veuillez suivre les instructions pour l'entraîner d'abord.");
                return;
            }
            
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'flex';
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Erreur: ' + result.error);
                    loadingSpinner.style.display = 'none';
                    return;
                }
                
                // Afficher les résultats
                document.getElementById('predicted-type').textContent = result.cancer_type;
                document.getElementById('confidence-value').textContent = result.confidence.toFixed(2);
                
                const confidenceBar = document.getElementById('confidence-bar');
                confidenceBar.style.width = result.confidence + '%';
                confidenceBar.textContent = result.confidence.toFixed(2) + '%';
                
                // Mettre à jour le graphique
                updateChart(result.all_probabilities);
                
                // Afficher la section des résultats
                document.getElementById('results').style.display = 'flex';
                
                // Scroll vers les résultats
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert('Une erreur est survenue: ' + error.message);
            } finally {
                loadingSpinner.style.display = 'none';
            }
        });
        
        document.getElementById('loadSample').addEventListener('click', async function() {
            if (!mlReady) return;
            
            try {
                const response = await fetch('/sample_data');
                const samples = await response.json();
                
                // Utiliser l'exemple du cancer du sein
                const breastCancerSample = samples["Cancer du sein"];
                
                // Remplir le formulaire avec ces valeurs
                const genes = [{% for gene in genes %}'{{ gene }}'{% if not loop.last %}, {% endif %}{% endfor %}];
                
                genes.forEach((gene, index) => {
                    document.getElementById(gene).value = breastCancerSample[index] || 0;
                });
                
            } catch (error) {
                alert('Erreur lors du chargement des données d\'exemple: ' + error.message);
            }
        });
        
        document.getElementById('clearForm').addEventListener('click', function() {
            if (!mlReady) return;
            
            document.getElementById('gene-form').reset();
            document.getElementById('results').style.display = 'none';
        });
        
        function updateChart(probabilities) {
            const ctx = document.getElementById('probability-chart').getContext('2d');
            
            // Détruire le graphique précédent s'il existe
            if (chart) {
                chart.destroy();
            }
            
            // Créer un nouveau graphique
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(probabilities),
                    datasets: [{
                        label: 'Probabilité (%)',
                        data: Object.values(probabilities),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // S'assurer que le spinner est bien caché au chargement initial
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loading-spinner').style.display = 'none';
        });
    </script>
</body>
</html>